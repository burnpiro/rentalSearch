(function () {
    angular.module('RentalBackgroundApp', [
        'ui.router', 'rental-services'
    ])
})();
(function () {
    angular.module('RentalBackgroundApp')
        .config(function ($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/');
            $stateProvider
                .state('background', {
                    name: 'background',
                    url: '/',
                    controller: 'BackgroundController'
                })
        })
})();
(function () {
    angular.module('RentalBackgroundApp')
        .controller('BackgroundController', ['$scope', '$http', '$interval', 'LinkService',
            function($scope, $http, $interval, LinkService) {
                var list = [];
                var settings = {
                    interval: 1,
                    olxLink: 'http://olx.pl/nieruchomosci/mieszkania/wynajem/',
                    gumtreeLink: 'http://www.gumtree.pl/f-SearchAdRss?CatId=9008&Location=202',
                    advanced: true,
                    location: {
                        display: '',
                        name: '',
                        value: ''
                    },
                    owner: null,
                    priceTo: null,
                    priceFrom: null,
                    areaTo: null,
                    areaFrom: null
                };
                var setList, getDataFromOlx, getUnseen, getSettings, setSettings, prepareOlxLink,
                    getDataFromGumtree, getOldList, checkIfNotToMuchData;

                $scope.counter = 0;

                chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
                    switch (request.get) {
                        case 'list':
                            sendResponse(list);
                            break;
                        case 'settings':
                            sendResponse(settings);
                            break;
                    }
                    switch (request.set) {
                        case 'seen':
                            if(!_.isUndefined(request.seen)) {
                                if(request.type === 'olx') {
                                    _.find(list, function(el) {
                                        return el.hashId === parseInt(request.seen);
                                    }).seen = true;
                                } else if(request.type === 'gumtree') {
                                    _.find(list, function(el) {
                                        return el.id === parseInt(request.seen);
                                    }).seen = true;
                                }
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                                setList(list);
                            }
                            sendResponse('Success');
                            break;
                        case 'settings':
                            setSettings(request.settings);
                            break;
                    }
                });

                getOldList = function() {
                    chrome.storage.local.get(function(items) {
                        _.forEach(items, function(item) {
                            if(!_.isUndefined(item.id)) {
                                list.push(item);
                            }
                        });
                    });
                    getDataFromOlx();
                    getDataFromGumtree();
                };

                setList = function(elements) {
                    var olxData = {
                    };
                    _.forEach(elements, function(element, index) {
                        olxData[index] = element;
                    });
                    chrome.storage.local.set(olxData, function() {
                        // Notify that we saved.
                    });
                };

                getUnseen = function() {
                    var numberOfUnseen = 0;
                    _.forEach(list, function(element) {
                        if(element.seen === false) {
                            numberOfUnseen++;
                        }
                    });
                    return numberOfUnseen;
                };

                getDataFromOlx = function() {
                    var olxLink = settings.olxLink;
                    if(!settings.advanced) {
                        olxLink = LinkService.getOlxLinkBySettings(settings);
                    }
                    $http.get(olxLink)
                        .success(function(data) {
                            var site = $(data);
                            var reversedTempData = [];
                            site.find('#offers_table').find('tr td.offer').each(function(index, element) {
                                if(!_.isUndefined($(element).find('.observelinkinfo a').attr('class'))) {
                                    var id = $(element).find('.observelinkinfo a').attr('class').split(' ')[0].replace(/id|:|}|{/gm,'');
                                    if(_.isUndefined(_.find(list, function(el) {
                                            return el.hashId === parseInt(id);
                                        }))) {
                                        reversedTempData.unshift({
                                            hashId: parseInt(id),
                                            date: new Date(),
                                            price: _.trim($(element).find('.td-price .c000').html()),
                                            name: $(element).find('.linkWithHash span').html(),
                                            link: $(element).find('.linkWithHash').attr('href'),
                                            img: $(element).find('.linkWithHash img').attr('src'),
                                            seen: false,
                                            type: 'olx'
                                        });
                                    }
                                }
                            });
                            _.forEach(reversedTempData, function(element) {
                                list.unshift(element);
                            });

                            chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            setList(list);
                        }).
                        error(function(data,status,headers,config) {
                            console.log('error :(', status, config, data);
                        });
                };

                getDataFromGumtree = function() {
                    var gumtreeLink = settings.gumtreeLink;

                    if(!settings.advanced) {
                        gumtreeLink = LinkService.getGumtreeLinkBySettings(settings);
                    }
                    // cannot use $http.jsonp() because of Content Security Policy
                    $http.get(gumtreeLink)
                        .success(function(data) {
                            var feed = $(data);

                            feed.find('item').each(function(index, element) {
                                var gumtreeElement = {
                                    name: _.trim($(element).find('title').text()),
                                    link: $(element).find('guid').html(),
                                    date: _.trim($(element).find("pubdate").html()),
                                    id: parseInt((new Date(_.trim($(element).find("pubdate").html()))).valueOf()),
                                    seen: false,
                                    type: 'gumtree'
                                };
                                if(_.isUndefined(_.find(list, { 'type': 'gumtree', 'id': gumtreeElement.id }))) {
                                    list.unshift(gumtreeElement);
                                }
                            });

                            chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            setList(list);
                        }).
                        error(function(data,status,headers,config) {
                            console.log('error :(', status, config, data);
                        });
                };

                setSettings = function (settings) {
                    chrome.storage.sync.set({settings: settings}, function() {
                        // No need to notify that settings has been saved.
                        chrome.storage.local.clear();
                        list = [];
                        getSettings();
                    });
                };

                getSettings = function () {
                    chrome.storage.sync.get('settings', function(storedSettings) {
                        if(!_.isUndefined(storedSettings.settings) && !_.isUndefined(storedSettings.settings.olxLink)) {
                            settings = storedSettings.settings;
                        }
                        getOldList();
                    });
                };

                checkIfNotToMuchData = function() {
                    if(list.length > 500) {
                        var tempList = [];
                        for(var i =0; i<500; i++) {
                            tempList.push(list[i]);
                        }
                        list = tempList;
                        chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                        setList(list);
                    }
                };

                getSettings();
                $interval(function() {
                    getDataFromOlx();
                    getDataFromGumtree();
                    checkIfNotToMuchData();
                }, settings.interval*60*1000);
            }]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tncm91bmQubW9kdWxlLmpzIiwiYmFja2dyb3VuZC5yb3V0ZS5qcyIsImJhY2tncm91bmRDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJiYWNrZ3JvdW5kLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiAoKSB7XG4gICAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnLCBbXG4gICAgICAgICd1aS5yb3V0ZXInLCAncmVudGFsLXNlcnZpY2VzJ1xuICAgIF0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG4gICAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnKVxuICAgICAgICAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlciwgJHVybFJvdXRlclByb3ZpZGVyKSB7XG4gICAgICAgICAgICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG4gICAgICAgICAgICAkc3RhdGVQcm92aWRlclxuICAgICAgICAgICAgICAgIC5zdGF0ZSgnYmFja2dyb3VuZCcsIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2JhY2tncm91bmQnLFxuICAgICAgICAgICAgICAgICAgICB1cmw6ICcvJyxcbiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ0JhY2tncm91bmRDb250cm9sbGVyJ1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG4gICAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnKVxuICAgICAgICAuY29udHJvbGxlcignQmFja2dyb3VuZENvbnRyb2xsZXInLCBbJyRzY29wZScsICckaHR0cCcsICckaW50ZXJ2YWwnLCAnTGlua1NlcnZpY2UnLFxuICAgICAgICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkaHR0cCwgJGludGVydmFsLCBMaW5rU2VydmljZSkge1xuICAgICAgICAgICAgICAgIHZhciBsaXN0ID0gW107XG4gICAgICAgICAgICAgICAgdmFyIHNldHRpbmdzID0ge1xuICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbDogMSxcbiAgICAgICAgICAgICAgICAgICAgb2x4TGluazogJ2h0dHA6Ly9vbHgucGwvbmllcnVjaG9tb3NjaS9taWVzemthbmlhL3d5bmFqZW0vJyxcbiAgICAgICAgICAgICAgICAgICAgZ3VtdHJlZUxpbms6ICdodHRwOi8vd3d3Lmd1bXRyZWUucGwvZi1TZWFyY2hBZFJzcz9DYXRJZD05MDA4JkxvY2F0aW9uPTIwMicsXG4gICAgICAgICAgICAgICAgICAgIGFkdmFuY2VkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAnJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBvd25lcjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgcHJpY2VUbzogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgcHJpY2VGcm9tOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBhcmVhVG86IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGFyZWFGcm9tOiBudWxsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB2YXIgc2V0TGlzdCwgZ2V0RGF0YUZyb21PbHgsIGdldFVuc2VlbiwgZ2V0U2V0dGluZ3MsIHNldFNldHRpbmdzLCBwcmVwYXJlT2x4TGluayxcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlLCBnZXRPbGRMaXN0LCBjaGVja0lmTm90VG9NdWNoRGF0YTtcblxuICAgICAgICAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDtcblxuICAgICAgICAgICAgICAgIGNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcihmdW5jdGlvbihyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlcXVlc3QuZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsaXN0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzZXR0aW5ncyc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlcXVlc3Quc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzZWVuJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighXy5pc1VuZGVmaW5lZChyZXF1ZXN0LnNlZW4pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlcXVlc3QudHlwZSA9PT0gJ29seCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZmluZChsaXN0LCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5oYXNoSWQgPT09IHBhcnNlSW50KHJlcXVlc3Quc2Vlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5zZWVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKHJlcXVlc3QudHlwZSA9PT0gJ2d1bXRyZWUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmZpbmQobGlzdCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuaWQgPT09IHBhcnNlSW50KHJlcXVlc3Quc2Vlbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5zZWVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnK2dldFVuc2VlbigpKycnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldExpc3QobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSgnU3VjY2VzcycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFNldHRpbmdzKHJlcXVlc3Quc2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBnZXRPbGRMaXN0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChmdW5jdGlvbihpdGVtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQoaXRlbS5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKCk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHNldExpc3QgPSBmdW5jdGlvbihlbGVtZW50cykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2x4RGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbihlbGVtZW50LCBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2x4RGF0YVtpbmRleF0gPSBlbGVtZW50O1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KG9seERhdGEsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90aWZ5IHRoYXQgd2Ugc2F2ZWQuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRVbnNlZW4gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG51bWJlck9mVW5zZWVuID0gMDtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGxpc3QsIGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVsZW1lbnQuc2VlbiA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXJPZlVuc2VlbisrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bWJlck9mVW5zZWVuO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXREYXRhRnJvbU9seCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2x4TGluayA9IHNldHRpbmdzLm9seExpbms7XG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5hZHZhbmNlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2x4TGluayA9IExpbmtTZXJ2aWNlLmdldE9seExpbmtCeVNldHRpbmdzKHNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob2x4TGluaylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2l0ZSA9ICQoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldmVyc2VkVGVtcERhdGEgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXRlLmZpbmQoJyNvZmZlcnNfdGFibGUnKS5maW5kKCd0ciB0ZC5vZmZlcicpLmVhY2goZnVuY3Rpb24oaW5kZXgsIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQoJChlbGVtZW50KS5maW5kKCcub2JzZXJ2ZWxpbmtpbmZvIGEnKS5hdHRyKCdjbGFzcycpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gJChlbGVtZW50KS5maW5kKCcub2JzZXJ2ZWxpbmtpbmZvIGEnKS5hdHRyKCdjbGFzcycpLnNwbGl0KCcgJylbMF0ucmVwbGFjZSgvaWR8Onx9fHsvZ20sJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoXy5pc1VuZGVmaW5lZChfLmZpbmQobGlzdCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQoaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldmVyc2VkVGVtcERhdGEudW5zaGlmdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hJZDogcGFyc2VJbnQoaWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogXy50cmltKCQoZWxlbWVudCkuZmluZCgnLnRkLXByaWNlIC5jMDAwJykuaHRtbCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJChlbGVtZW50KS5maW5kKCcubGlua1dpdGhIYXNoIHNwYW4nKS5odG1sKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6ICQoZWxlbWVudCkuZmluZCgnLmxpbmtXaXRoSGFzaCcpLmF0dHIoJ2hyZWYnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiAkKGVsZW1lbnQpLmZpbmQoJy5saW5rV2l0aEhhc2ggaW1nJykuYXR0cignc3JjJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZW46IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnb2x4J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKHJldmVyc2VkVGVtcERhdGEsIGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC51bnNoaWZ0KGVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldExpc3QobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsc3RhdHVzLGhlYWRlcnMsY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDooJywgc3RhdHVzLCBjb25maWcsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZ3VtdHJlZUxpbmsgPSBzZXR0aW5ncy5ndW10cmVlTGluaztcblxuICAgICAgICAgICAgICAgICAgICBpZighc2V0dGluZ3MuYWR2YW5jZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGd1bXRyZWVMaW5rID0gTGlua1NlcnZpY2UuZ2V0R3VtdHJlZUxpbmtCeVNldHRpbmdzKHNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBjYW5ub3QgdXNlICRodHRwLmpzb25wKCkgYmVjYXVzZSBvZiBDb250ZW50IFNlY3VyaXR5IFBvbGljeVxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQoZ3VtdHJlZUxpbmspXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlZWQgPSAkKGRhdGEpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVlZC5maW5kKCdpdGVtJykuZWFjaChmdW5jdGlvbihpbmRleCwgZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3VtdHJlZUVsZW1lbnQgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBfLnRyaW0oJChlbGVtZW50KS5maW5kKCd0aXRsZScpLnRleHQoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiAkKGVsZW1lbnQpLmZpbmQoJ2d1aWQnKS5odG1sKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlOiBfLnRyaW0oJChlbGVtZW50KS5maW5kKFwicHViZGF0ZVwiKS5odG1sKCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHBhcnNlSW50KChuZXcgRGF0ZShfLnRyaW0oJChlbGVtZW50KS5maW5kKFwicHViZGF0ZVwiKS5odG1sKCkpKSkudmFsdWVPZigpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZW46IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2d1bXRyZWUnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF8uaXNVbmRlZmluZWQoXy5maW5kKGxpc3QsIHsgJ3R5cGUnOiAnZ3VtdHJlZScsICdpZCc6IGd1bXRyZWVFbGVtZW50LmlkIH0pKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC51bnNoaWZ0KGd1bXRyZWVFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldExpc3QobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsc3RhdHVzLGhlYWRlcnMsY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDooJywgc3RhdHVzLCBjb25maWcsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHNldFNldHRpbmdzID0gZnVuY3Rpb24gKHNldHRpbmdzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNocm9tZS5zdG9yYWdlLnN5bmMuc2V0KHtzZXR0aW5nczogc2V0dGluZ3N9LCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gbm90aWZ5IHRoYXQgc2V0dGluZ3MgaGFzIGJlZW4gc2F2ZWQuXG4gICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5jbGVhcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0U2V0dGluZ3MoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGdldFNldHRpbmdzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5zeW5jLmdldCgnc2V0dGluZ3MnLCBmdW5jdGlvbihzdG9yZWRTZXR0aW5ncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQoc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3MpICYmICFfLmlzVW5kZWZpbmVkKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLm9seExpbmspKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MgPSBzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGdldE9sZExpc3QoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGNoZWNrSWZOb3RUb011Y2hEYXRhID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGxpc3QubGVuZ3RoID4gNTAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcExpc3QgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9MDsgaTw1MDA7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBMaXN0LnB1c2gobGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0ID0gdGVtcExpc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnK2dldFVuc2VlbigpKycnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGdldFNldHRpbmdzKCk7XG4gICAgICAgICAgICAgICAgJGludGVydmFsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBnZXREYXRhRnJvbU9seCgpO1xuICAgICAgICAgICAgICAgICAgICBnZXREYXRhRnJvbUd1bXRyZWUoKTtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tJZk5vdFRvTXVjaERhdGEoKTtcbiAgICAgICAgICAgICAgICB9LCBzZXR0aW5ncy5pbnRlcnZhbCo2MCoxMDAwKTtcbiAgICAgICAgICAgIH1dKTtcbn0pKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9