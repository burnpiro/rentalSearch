(function () {
    angular.module('RentalBackgroundApp', [
        'ui.router', 'rental-services'
    ])
})();
(function () {
    angular.module('RentalBackgroundApp')
        .config(function ($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/');
            $stateProvider
                .state('background', {
                    name: 'background',
                    url: '/',
                    controller: 'BackgroundController'
                })
        })
})();
(function () {
  angular.module('RentalBackgroundApp')
    .controller('BackgroundController', ['$scope', '$http', '$interval', 'LinkService',
      function ($scope, $http, $interval, LinkService) {
        var list = []
        var settings = {
          interval: 1,
          olxLink: [
            'http://olx.pl/nieruchomosci/mieszkania/wynajem/'
          ],
          gumtreeLink: [
            'http://www.gumtree.pl/s-mieszkania-i-domy-do-wynajecia/v1c9008'
          ],
          advanced: true,
          location: {
            display: '',
            name: '',
            value: ''
          },
          owner: null,
          priceTo: null,
          priceFrom: null,
          areaTo: null,
          areaFrom: null,
          allowNotifications: true,
          automaticallyMarkAsSeen: false
        }
        var setList, getDataFromOlx, getUnseen, getSettings, setSettings, prepareOlxLink,
          getDataFromGumtree, getOldList, checkIfNotToMuchData

        $scope.counter = 0

        chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
          switch (request.get) {
            case 'list':
              sendResponse(list)
              if (settings.automaticallyMarkAsSeen) {
                _.forEach(list, function (el) {
                  el.seen = true
                })
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
              }
              break
            case 'settings':
              sendResponse(settings)
              break
          }
          switch (request.set) {
            case 'seen':
              if (!_.isUndefined(request.seen)) {
                _.find(list, function (el) {
                  return el.hashId === parseInt(request.seen)
                }).seen = true
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }
              sendResponse('Success')
              break
            case 'allSeen':
              if (!_.isUndefined(request.type)) {
                _.forEach(list, function (el) {
                  if (el.type === request.type) {
                    el.seen = true
                  }
                })
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }
              sendResponse('Success')
              break
            case 'settings':
              setSettings(request.settings)
              break
          }
        })

        getOldList = function () {
          chrome.storage.local.get(function (items) {
            _.forEach(items, function (item) {
              if (!_.isUndefined(item.id)) {
                list.push(item)
              }
            })
          })
          getDataFromOlx()
          getDataFromGumtree()
          checkIfNotToMuchData()
          var unseen = getUnseen()
          if(unseen > 0 && settings.allowNotifications) {
            showNotification(unseen + ' Nowe ogłoszenia', 'Masz nieprzeczytane ogłoszenia zgodne z twoimi kryteriami')
          }
        }

        setList = function (elements) {
          var olxData = {}
          _.forEach(elements, function (element, index) {
            olxData[index] = element
          })
          chrome.storage.local.set(olxData, function () {
            // Notify that we saved.
          })
        }

        getUnseen = function () {
          var numberOfUnseen = 0
          _.forEach(list, function (element) {
            if (element.seen === false) {
              numberOfUnseen++
            }
          })
          return numberOfUnseen
        }

        getDataFromOlx = function () {
          var olxLink = settings.olxLink
          if (!settings.advanced) {
            olxLink = LinkService.getOlxLinkBySettings(settings)
          }
          if (!olxLink) {
            return false
          }

          olxLink.forEach(function (link) {
            if (!link) {
              return
            }
            $http.get(link)
              .success(function (data) {
                var site = $(data)
                var reversedTempData = []
                site.find('#offers_table').find('tr td.offer').each(function (index, element) {
                  if (!_.isUndefined($(element).find('.observelinkinfo a').attr('class'))) {
                    var id = $(element).find('.observelinkinfo a').attr('class').split(' ')[0].replace(/id|:|}|{/gm, '')
                    if (_.isUndefined(_.find(list, function (el) {
                        return el.hashId === parseInt(id)
                      }))) {
                      reversedTempData.unshift({
                        hashId: parseInt(id),
                        date: new Date(),
                        price: _.trim($(element).find('p.price strong').html()),
                        name: $(element).find('.linkWithHash strong').html(),
                        link: $(element).find('.linkWithHash').attr('href'),
                        img: $(element).find('.linkWithHash img').attr('src'),
                        seen: false,
                        type: 'olx'
                      })
                    }
                  }
                })
                _.forEach(reversedTempData, function (element) {
                  list.unshift(element)
                })

                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }).error(function (data, status, headers, config) {
              console.log('error :(')
            })
          })
        }

        getDataFromGumtree = function () {
          var gumtreeLink = settings.gumtreeLink

          if (!settings.advanced) {
            gumtreeLink = LinkService.getGumtreeLinkBySettings(settings)
          }
          // cannot use $http.jsonp() because of Content Security Policy
          if (!gumtreeLink) {
            return false
          }

          gumtreeLink.forEach(function (link) {
            if (!link) {
              return
            }
            for (var i = 1; i < 6; i++) {
              var pageLink = link
              if (i > 1) {
                pageLink = link.split('p1?')[1] ? (link.split('p1?')[0] + 'p' + i + '?'
                + link.split('p1?')[1]) : link
              }
              if (i > 2 && link.indexOf('p1?') === -1) {
                return
              }
              $http.get(pageLink)
                .success(function (data) {
                  var feed = $(data)
                  var reversedTempData = []

                  feed.find('.view:not(.top-listings)').find('ul li.result').each(function (index, element) {
                    var id = $(element).find('.addAdTofav').attr('data-adid')
                    if (_.isUndefined(_.find(list, function (el) {
                        return el.hashId === parseInt(id)
                      })) && !_.isUndefined(id)) {
                      reversedTempData.unshift({
                        hashId: parseInt(id),
                        price: _.trim($(element).find('.price .amount').html().replace('&nbsp;', ' ')),
                        name: _.trim($(element).find('.href-link').text()),
                        link: 'http://www.gumtree.pl' + $(element).find('.href-link').attr('href'),
                        img: $(element).find('#img-cnt img').attr('src'),
                        date: new Date(),
                        seen: false,
                        type: 'gumtree'
                      })
                    }
                  })

                  _.forEach(reversedTempData, function (element) {
                    list.unshift(element)
                  })

                  chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                  setList(list)
                }).error(function (data, status, headers, config) {
                console.log('error :(')
              })
            }
          })
        }

        setSettings = function (settings) {
          chrome.storage.sync.set({settings: settings}, function () {
            // No need to notify that settings has been saved.
            chrome.storage.local.clear()
            list = []
            getSettings()
          })
        }

        getSettings = function () {
          chrome.storage.sync.get('settings', function (storedSettings) {
            if (!_.isUndefined(storedSettings.settings) && !_.isUndefined(storedSettings.settings.olxLink)) {
              if (typeof storedSettings.settings.olxLink === 'string') {
                storedSettings.settings.olxLink = [
                  storedSettings.settings.olxLink
                ]
              }
              if (typeof storedSettings.settings.gumtreeLink === 'string') {
                storedSettings.settings.gumtreeLink = [
                  storedSettings.settings.gumtreeLink
                ]
              }
              if (storedSettings.settings.allowNotifications === undefined) {
                storedSettings.settings.allowNotifications = true
              }
              settings = storedSettings.settings
            }
            getOldList()
          })
        }

        checkIfNotToMuchData = function () {
          if (list.length > 500) {
            var tempList = []
            for (var i = 0; i < 500; i++) {
              tempList.push(list[i])
            }
            list = tempList
            chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
            setList(list)
          }
        }

        showNotification = function (title, message) {
          chrome.notifications.create('rentalWatchNotification', {
            type: 'basic',
            iconUrl: '/img/mainIcon.png',
            title: title,
            message: message
          }, function(notificationId) {
            setTimeout(function(){
              chrome.notifications.clear(notificationId)
            },3000);
          })
        }

        getSettings()
        $interval(function () {
          getDataFromOlx()
          getDataFromGumtree()
          checkIfNotToMuchData()
          var unseen = getUnseen()
          if(unseen > 0 && settings.allowNotifications) {
            showNotification(unseen + ' Nowe ogłoszenia', 'Masz nieprzeczytane ogłoszenia zgodne z twoimi kryteriami')
          }
        }, settings.interval * 60 * 1000)
      }])
})()
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tncm91bmQubW9kdWxlLmpzIiwiYmFja2dyb3VuZC5yb3V0ZS5qcyIsImJhY2tncm91bmRDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJiYWNrZ3JvdW5kLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiAoKSB7XG4gICAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnLCBbXG4gICAgICAgICd1aS5yb3V0ZXInLCAncmVudGFsLXNlcnZpY2VzJ1xuICAgIF0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG4gICAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnKVxuICAgICAgICAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlciwgJHVybFJvdXRlclByb3ZpZGVyKSB7XG4gICAgICAgICAgICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG4gICAgICAgICAgICAkc3RhdGVQcm92aWRlclxuICAgICAgICAgICAgICAgIC5zdGF0ZSgnYmFja2dyb3VuZCcsIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2JhY2tncm91bmQnLFxuICAgICAgICAgICAgICAgICAgICB1cmw6ICcvJyxcbiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ0JhY2tncm91bmRDb250cm9sbGVyJ1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XG4gIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJylcbiAgICAuY29udHJvbGxlcignQmFja2dyb3VuZENvbnRyb2xsZXInLCBbJyRzY29wZScsICckaHR0cCcsICckaW50ZXJ2YWwnLCAnTGlua1NlcnZpY2UnLFxuICAgICAgZnVuY3Rpb24gKCRzY29wZSwgJGh0dHAsICRpbnRlcnZhbCwgTGlua1NlcnZpY2UpIHtcbiAgICAgICAgdmFyIGxpc3QgPSBbXVxuICAgICAgICB2YXIgc2V0dGluZ3MgPSB7XG4gICAgICAgICAgaW50ZXJ2YWw6IDEsXG4gICAgICAgICAgb2x4TGluazogW1xuICAgICAgICAgICAgJ2h0dHA6Ly9vbHgucGwvbmllcnVjaG9tb3NjaS9taWVzemthbmlhL3d5bmFqZW0vJ1xuICAgICAgICAgIF0sXG4gICAgICAgICAgZ3VtdHJlZUxpbms6IFtcbiAgICAgICAgICAgICdodHRwOi8vd3d3Lmd1bXRyZWUucGwvcy1taWVzemthbmlhLWktZG9teS1kby13eW5hamVjaWEvdjFjOTAwOCdcbiAgICAgICAgICBdLFxuICAgICAgICAgIGFkdmFuY2VkOiB0cnVlLFxuICAgICAgICAgIGxvY2F0aW9uOiB7XG4gICAgICAgICAgICBkaXNwbGF5OiAnJyxcbiAgICAgICAgICAgIG5hbWU6ICcnLFxuICAgICAgICAgICAgdmFsdWU6ICcnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBvd25lcjogbnVsbCxcbiAgICAgICAgICBwcmljZVRvOiBudWxsLFxuICAgICAgICAgIHByaWNlRnJvbTogbnVsbCxcbiAgICAgICAgICBhcmVhVG86IG51bGwsXG4gICAgICAgICAgYXJlYUZyb206IG51bGwsXG4gICAgICAgICAgYWxsb3dOb3RpZmljYXRpb25zOiB0cnVlLFxuICAgICAgICAgIGF1dG9tYXRpY2FsbHlNYXJrQXNTZWVuOiBmYWxzZVxuICAgICAgICB9XG4gICAgICAgIHZhciBzZXRMaXN0LCBnZXREYXRhRnJvbU9seCwgZ2V0VW5zZWVuLCBnZXRTZXR0aW5ncywgc2V0U2V0dGluZ3MsIHByZXBhcmVPbHhMaW5rLFxuICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSwgZ2V0T2xkTGlzdCwgY2hlY2tJZk5vdFRvTXVjaERhdGFcblxuICAgICAgICAkc2NvcGUuY291bnRlciA9IDBcblxuICAgICAgICBjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UuYWRkTGlzdGVuZXIoZnVuY3Rpb24gKHJlcXVlc3QsIHNlbmRlciwgc2VuZFJlc3BvbnNlKSB7XG4gICAgICAgICAgc3dpdGNoIChyZXF1ZXN0LmdldCkge1xuICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICAgIHNlbmRSZXNwb25zZShsaXN0KVxuICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuYXV0b21hdGljYWxseU1hcmtBc1NlZW4pIHtcbiAgICAgICAgICAgICAgICBfLmZvckVhY2gobGlzdCwgZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICAgICAgICBlbC5zZWVuID0gdHJ1ZVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBjYXNlICdzZXR0aW5ncyc6XG4gICAgICAgICAgICAgIHNlbmRSZXNwb25zZShzZXR0aW5ncylcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgICAgc3dpdGNoIChyZXF1ZXN0LnNldCkge1xuICAgICAgICAgICAgY2FzZSAnc2Vlbic6XG4gICAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChyZXF1ZXN0LnNlZW4pKSB7XG4gICAgICAgICAgICAgICAgXy5maW5kKGxpc3QsIGZ1bmN0aW9uIChlbCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQocmVxdWVzdC5zZWVuKVxuICAgICAgICAgICAgICAgIH0pLnNlZW4gPSB0cnVlXG4gICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgICAgIHNldExpc3QobGlzdClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoJ1N1Y2Nlc3MnKVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSAnYWxsU2Vlbic6XG4gICAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChyZXF1ZXN0LnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JFYWNoKGxpc3QsIGZ1bmN0aW9uIChlbCkge1xuICAgICAgICAgICAgICAgICAgaWYgKGVsLnR5cGUgPT09IHJlcXVlc3QudHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBlbC5zZWVuID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgICAgIHNldExpc3QobGlzdClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoJ1N1Y2Nlc3MnKVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxuICAgICAgICAgICAgICBzZXRTZXR0aW5ncyhyZXF1ZXN0LnNldHRpbmdzKVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICBnZXRPbGRMaXN0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChmdW5jdGlvbiAoaXRlbXMpIHtcbiAgICAgICAgICAgIF8uZm9yRWFjaChpdGVtcywgZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGl0ZW0uaWQpKSB7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKGl0ZW0pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSlcbiAgICAgICAgICBnZXREYXRhRnJvbU9seCgpXG4gICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKClcbiAgICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSgpXG4gICAgICAgICAgdmFyIHVuc2VlbiA9IGdldFVuc2VlbigpXG4gICAgICAgICAgaWYodW5zZWVuID4gMCAmJiBzZXR0aW5ncy5hbGxvd05vdGlmaWNhdGlvbnMpIHtcbiAgICAgICAgICAgIHNob3dOb3RpZmljYXRpb24odW5zZWVuICsgJyBOb3dlIG9nxYJvc3plbmlhJywgJ01hc3ogbmllcHJ6ZWN6eXRhbmUgb2fFgm9zemVuaWEgemdvZG5lIHogdHdvaW1pIGtyeXRlcmlhbWknKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNldExpc3QgPSBmdW5jdGlvbiAoZWxlbWVudHMpIHtcbiAgICAgICAgICB2YXIgb2x4RGF0YSA9IHt9XG4gICAgICAgICAgXy5mb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbWVudCwgaW5kZXgpIHtcbiAgICAgICAgICAgIG9seERhdGFbaW5kZXhdID0gZWxlbWVudFxuICAgICAgICAgIH0pXG4gICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KG9seERhdGEsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIE5vdGlmeSB0aGF0IHdlIHNhdmVkLlxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBnZXRVbnNlZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgdmFyIG51bWJlck9mVW5zZWVuID0gMFxuICAgICAgICAgIF8uZm9yRWFjaChsaXN0LCBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgICAgaWYgKGVsZW1lbnQuc2VlbiA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgbnVtYmVyT2ZVbnNlZW4rK1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIG51bWJlck9mVW5zZWVuXG4gICAgICAgIH1cblxuICAgICAgICBnZXREYXRhRnJvbU9seCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2YXIgb2x4TGluayA9IHNldHRpbmdzLm9seExpbmtcbiAgICAgICAgICBpZiAoIXNldHRpbmdzLmFkdmFuY2VkKSB7XG4gICAgICAgICAgICBvbHhMaW5rID0gTGlua1NlcnZpY2UuZ2V0T2x4TGlua0J5U2V0dGluZ3Moc2V0dGluZ3MpXG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghb2x4TGluaykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgb2x4TGluay5mb3JFYWNoKGZ1bmN0aW9uIChsaW5rKSB7XG4gICAgICAgICAgICBpZiAoIWxpbmspIHtcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkaHR0cC5nZXQobGluaylcbiAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2l0ZSA9ICQoZGF0YSlcbiAgICAgICAgICAgICAgICB2YXIgcmV2ZXJzZWRUZW1wRGF0YSA9IFtdXG4gICAgICAgICAgICAgICAgc2l0ZS5maW5kKCcjb2ZmZXJzX3RhYmxlJykuZmluZCgndHIgdGQub2ZmZXInKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKCQoZWxlbWVudCkuZmluZCgnLm9ic2VydmVsaW5raW5mbyBhJykuYXR0cignY2xhc3MnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gJChlbGVtZW50KS5maW5kKCcub2JzZXJ2ZWxpbmtpbmZvIGEnKS5hdHRyKCdjbGFzcycpLnNwbGl0KCcgJylbMF0ucmVwbGFjZSgvaWR8Onx9fHsvZ20sICcnKVxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChfLmZpbmQobGlzdCwgZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuaGFzaElkID09PSBwYXJzZUludChpZClcbiAgICAgICAgICAgICAgICAgICAgICB9KSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXZlcnNlZFRlbXBEYXRhLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzaElkOiBwYXJzZUludChpZCksXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2U6IF8udHJpbSgkKGVsZW1lbnQpLmZpbmQoJ3AucHJpY2Ugc3Ryb25nJykuaHRtbCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICQoZWxlbWVudCkuZmluZCgnLmxpbmtXaXRoSGFzaCBzdHJvbmcnKS5odG1sKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiAkKGVsZW1lbnQpLmZpbmQoJy5saW5rV2l0aEhhc2gnKS5hdHRyKCdocmVmJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBpbWc6ICQoZWxlbWVudCkuZmluZCgnLmxpbmtXaXRoSGFzaCBpbWcnKS5hdHRyKCdzcmMnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZW46IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ29seCdcbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBfLmZvckVhY2gocmV2ZXJzZWRUZW1wRGF0YSwgZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgIGxpc3QudW5zaGlmdChlbGVtZW50KVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnICsgZ2V0VW5zZWVuKCkgKyAnJ30pXG4gICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KVxuICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIDooJylcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2YXIgZ3VtdHJlZUxpbmsgPSBzZXR0aW5ncy5ndW10cmVlTGlua1xuXG4gICAgICAgICAgaWYgKCFzZXR0aW5ncy5hZHZhbmNlZCkge1xuICAgICAgICAgICAgZ3VtdHJlZUxpbmsgPSBMaW5rU2VydmljZS5nZXRHdW10cmVlTGlua0J5U2V0dGluZ3Moc2V0dGluZ3MpXG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIGNhbm5vdCB1c2UgJGh0dHAuanNvbnAoKSBiZWNhdXNlIG9mIENvbnRlbnQgU2VjdXJpdHkgUG9saWN5XG4gICAgICAgICAgaWYgKCFndW10cmVlTGluaykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZ3VtdHJlZUxpbmsuZm9yRWFjaChmdW5jdGlvbiAobGluaykge1xuICAgICAgICAgICAgaWYgKCFsaW5rKSB7XG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCA2OyBpKyspIHtcbiAgICAgICAgICAgICAgdmFyIHBhZ2VMaW5rID0gbGlua1xuICAgICAgICAgICAgICBpZiAoaSA+IDEpIHtcbiAgICAgICAgICAgICAgICBwYWdlTGluayA9IGxpbmsuc3BsaXQoJ3AxPycpWzFdID8gKGxpbmsuc3BsaXQoJ3AxPycpWzBdICsgJ3AnICsgaSArICc/J1xuICAgICAgICAgICAgICAgICsgbGluay5zcGxpdCgncDE/JylbMV0pIDogbGlua1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChpID4gMiAmJiBsaW5rLmluZGV4T2YoJ3AxPycpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICRodHRwLmdldChwYWdlTGluaylcbiAgICAgICAgICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgdmFyIGZlZWQgPSAkKGRhdGEpXG4gICAgICAgICAgICAgICAgICB2YXIgcmV2ZXJzZWRUZW1wRGF0YSA9IFtdXG5cbiAgICAgICAgICAgICAgICAgIGZlZWQuZmluZCgnLnZpZXc6bm90KC50b3AtbGlzdGluZ3MpJykuZmluZCgndWwgbGkucmVzdWx0JykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gJChlbGVtZW50KS5maW5kKCcuYWRkQWRUb2ZhdicpLmF0dHIoJ2RhdGEtYWRpZCcpXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKF8uZmluZChsaXN0LCBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5oYXNoSWQgPT09IHBhcnNlSW50KGlkKVxuICAgICAgICAgICAgICAgICAgICAgIH0pKSAmJiAhXy5pc1VuZGVmaW5lZChpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXZlcnNlZFRlbXBEYXRhLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzaElkOiBwYXJzZUludChpZCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogXy50cmltKCQoZWxlbWVudCkuZmluZCgnLnByaWNlIC5hbW91bnQnKS5odG1sKCkucmVwbGFjZSgnJm5ic3A7JywgJyAnKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBfLnRyaW0oJChlbGVtZW50KS5maW5kKCcuaHJlZi1saW5rJykudGV4dCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6ICdodHRwOi8vd3d3Lmd1bXRyZWUucGwnICsgJChlbGVtZW50KS5maW5kKCcuaHJlZi1saW5rJykuYXR0cignaHJlZicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiAkKGVsZW1lbnQpLmZpbmQoJyNpbWctY250IGltZycpLmF0dHIoJ3NyYycpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZW46IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2d1bXRyZWUnXG4gICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKHJldmVyc2VkVGVtcERhdGEsIGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3QudW5zaGlmdChlbGVtZW50KVxuICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KVxuICAgICAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uIChkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6KCcpXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIHNldFNldHRpbmdzID0gZnVuY3Rpb24gKHNldHRpbmdzKSB7XG4gICAgICAgICAgY2hyb21lLnN0b3JhZ2Uuc3luYy5zZXQoe3NldHRpbmdzOiBzZXR0aW5nc30sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gbm90aWZ5IHRoYXQgc2V0dGluZ3MgaGFzIGJlZW4gc2F2ZWQuXG4gICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5jbGVhcigpXG4gICAgICAgICAgICBsaXN0ID0gW11cbiAgICAgICAgICAgIGdldFNldHRpbmdzKClcbiAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgZ2V0U2V0dGluZ3MgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgY2hyb21lLnN0b3JhZ2Uuc3luYy5nZXQoJ3NldHRpbmdzJywgZnVuY3Rpb24gKHN0b3JlZFNldHRpbmdzKSB7XG4gICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3MpICYmICFfLmlzVW5kZWZpbmVkKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLm9seExpbmspKSB7XG4gICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3Mub2x4TGluayA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5vbHhMaW5rID0gW1xuICAgICAgICAgICAgICAgICAgc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3Mub2x4TGlua1xuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLmd1bXRyZWVMaW5rID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLmd1bXRyZWVMaW5rID0gW1xuICAgICAgICAgICAgICAgICAgc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3MuZ3VtdHJlZUxpbmtcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLmFsbG93Tm90aWZpY2F0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3MuYWxsb3dOb3RpZmljYXRpb25zID0gdHJ1ZVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHNldHRpbmdzID0gc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3NcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldE9sZExpc3QoKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBpZiAobGlzdC5sZW5ndGggPiA1MDApIHtcbiAgICAgICAgICAgIHZhciB0ZW1wTGlzdCA9IFtdXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDUwMDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRlbXBMaXN0LnB1c2gobGlzdFtpXSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxpc3QgPSB0ZW1wTGlzdFxuICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgc2V0TGlzdChsaXN0KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHNob3dOb3RpZmljYXRpb24gPSBmdW5jdGlvbiAodGl0bGUsIG1lc3NhZ2UpIHtcbiAgICAgICAgICBjaHJvbWUubm90aWZpY2F0aW9ucy5jcmVhdGUoJ3JlbnRhbFdhdGNoTm90aWZpY2F0aW9uJywge1xuICAgICAgICAgICAgdHlwZTogJ2Jhc2ljJyxcbiAgICAgICAgICAgIGljb25Vcmw6ICcvaW1nL21haW5JY29uLnBuZycsXG4gICAgICAgICAgICB0aXRsZTogdGl0bGUsXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlXG4gICAgICAgICAgfSwgZnVuY3Rpb24obm90aWZpY2F0aW9uSWQpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgY2hyb21lLm5vdGlmaWNhdGlvbnMuY2xlYXIobm90aWZpY2F0aW9uSWQpXG4gICAgICAgICAgICB9LDMwMDApO1xuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBnZXRTZXR0aW5ncygpXG4gICAgICAgICRpbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKVxuICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSgpXG4gICAgICAgICAgY2hlY2tJZk5vdFRvTXVjaERhdGEoKVxuICAgICAgICAgIHZhciB1bnNlZW4gPSBnZXRVbnNlZW4oKVxuICAgICAgICAgIGlmKHVuc2VlbiA+IDAgJiYgc2V0dGluZ3MuYWxsb3dOb3RpZmljYXRpb25zKSB7XG4gICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKHVuc2VlbiArICcgTm93ZSBvZ8WCb3N6ZW5pYScsICdNYXN6IG5pZXByemVjenl0YW5lIG9nxYJvc3plbmlhIHpnb2RuZSB6IHR3b2ltaSBrcnl0ZXJpYW1pJylcbiAgICAgICAgICB9XG4gICAgICAgIH0sIHNldHRpbmdzLmludGVydmFsICogNjAgKiAxMDAwKVxuICAgICAgfV0pXG59KSgpIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9