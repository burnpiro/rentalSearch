(function () {
    angular.module('RentalBackgroundApp', [
        'ui.router', 'rental-services'
    ])
})();
(function () {
    angular.module('RentalBackgroundApp')
        .config(function ($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/');
            $stateProvider
                .state('background', {
                    name: 'background',
                    url: '/',
                    controller: 'BackgroundController'
                })
        })
})();
(function () {
    angular.module('RentalBackgroundApp')
        .controller('BackgroundController', ['$scope', '$http', '$interval', 'LinkService',
            function($scope, $http, $interval, LinkService) {
                var list = [];
                var settings = {
                    interval: 1,
                    olxLink: 'http://olx.pl/nieruchomosci/mieszkania/wynajem/',
                    gumtreeLink: 'http://www.gumtree.pl/s-mieszkania-i-domy-do-wynajecia/v1c9008',
                    advanced: true,
                    location: {
                        display: '',
                        name: '',
                        value: ''
                    },
                    owner: null,
                    priceTo: null,
                    priceFrom: null,
                    areaTo: null,
                    areaFrom: null,
                    automaticallyMarkAsSeen: false
                };
                var setList, getDataFromOlx, getUnseen, getSettings, setSettings, prepareOlxLink,
                    getDataFromGumtree, getOldList, checkIfNotToMuchData;

                $scope.counter = 0;

                chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
                    switch (request.get) {
                        case 'list':
                            sendResponse(list);
                            if(settings.automaticallyMarkAsSeen) {
                                _.forEach(list, function(el) {
                                    el.seen = true;
                                });
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            }
                            break;
                        case 'settings':
                            sendResponse(settings);
                            break;
                    }
                    switch (request.set) {
                        case 'seen':
                            if(!_.isUndefined(request.seen)) {
                                _.find(list, function(el) {
                                    return el.hashId === parseInt(request.seen);
                                }).seen = true;
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                                setList(list);
                            }
                            sendResponse('Success');
                            break;
                        case 'allSeen':
                            if(!_.isUndefined(request.type)) {
                                _.forEach(list, function(el) {
                                    if(el.type === request.type) {
                                        el.seen = true;
                                    }
                                });
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                                setList(list);
                            }
                            sendResponse('Success');
                            break;
                        case 'settings':
                            setSettings(request.settings);
                            break;
                    }
                });

                getOldList = function() {
                    chrome.storage.local.get(function(items) {
                        _.forEach(items, function(item) {
                            if(!_.isUndefined(item.id)) {
                                list.push(item);
                            }
                        });
                    });
                    getDataFromOlx();
                    getDataFromGumtree();
                };

                setList = function(elements) {
                    var olxData = {
                    };
                    _.forEach(elements, function(element, index) {
                        olxData[index] = element;
                    });
                    chrome.storage.local.set(olxData, function() {
                        // Notify that we saved.
                    });
                };

                getUnseen = function() {
                    var numberOfUnseen = 0;
                    _.forEach(list, function(element) {
                        if(element.seen === false) {
                            numberOfUnseen++;
                        }
                    });
                    return numberOfUnseen;
                };

                getDataFromOlx = function() {
                    var olxLink = settings.olxLink;
                    if(!settings.advanced) {
                        olxLink = LinkService.getOlxLinkBySettings(settings);
                    }
                    $http.get(olxLink)
                        .success(function(data) {
                            var site = $(data);
                            var reversedTempData = [];
                            site.find('#offers_table').find('tr td.offer').each(function(index, element) {
                                if(!_.isUndefined($(element).find('.observelinkinfo a').attr('class'))) {
                                    var id = $(element).find('.observelinkinfo a').attr('class').split(' ')[0].replace(/id|:|}|{/gm,'');
                                    if(_.isUndefined(_.find(list, function(el) {
                                            return el.hashId === parseInt(id);
                                        }))) {
                                        reversedTempData.unshift({
                                            hashId: parseInt(id),
                                            date: new Date(),
                                            price: _.trim($(element).find('.td-price .c000').html()),
                                            name: $(element).find('.linkWithHash strong').html(),
                                            link: $(element).find('.linkWithHash').attr('href'),
                                            img: $(element).find('.linkWithHash img').attr('src'),
                                            seen: false,
                                            type: 'olx'
                                        });
                                    }
                                }
                            });
                            _.forEach(reversedTempData, function(element) {
                                list.unshift(element);
                            });

                            chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            setList(list);
                        }).
                        error(function(data,status,headers,config) {
                            console.log('error :(', status, config, data);
                        });
                };

                getDataFromGumtree = function() {
                    var gumtreeLink = settings.gumtreeLink;

                    if(!settings.advanced) {
                        gumtreeLink = LinkService.getGumtreeLinkBySettings(settings);
                    }
                    // cannot use $http.jsonp() because of Content Security Policy
                    for(var i=1; i<6; i++) {
                        var pageLink = gumtreeLink;
                        if(i>1) {
                            pageLink = gumtreeLink.split('p1?')[0]+'p'+i+'?'
                            +gumtreeLink.split('p1?')[1];
                        }
                        $http.get(pageLink)
                            .success(function(data) {
                                var feed = $(data);
                                var reversedTempData = [];

                                feed.find('.view:not(.top-listings)').find('ul li.result').each(function(index, element) {
                                    var id = $(element).find('.addAdTofav').attr('data-adid');
                                    if(_.isUndefined(_.find(list, function(el) {
                                            return el.hashId === parseInt(id);
                                        })) && !_.isUndefined(id)) {
                                        reversedTempData.unshift({
                                            hashId: parseInt(id),
                                            price: _.trim($(element).find('.price .amount').html().replace('&nbsp;', ' ')),
                                            name: _.trim($(element).find('.href-link').text()),
                                            link: 'http://www.gumtree.pl'+$(element).find('.href-link').attr('href'),
                                            img: $(element).find('#img-cnt img').attr('src'),
                                            date: new Date(),
                                            seen: false,
                                            type: 'gumtree'
                                        });
                                    }
                                });

                                _.forEach(reversedTempData, function(element) {
                                    list.unshift(element);
                                });

                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                                setList(list);
                            }).
                            error(function(data,status,headers,config) {
                                console.log('error :(', status, config, data);
                            });
                    }
                };

                setSettings = function (settings) {
                    chrome.storage.sync.set({settings: settings}, function() {
                        // No need to notify that settings has been saved.
                        chrome.storage.local.clear();
                        list = [];
                        getSettings();
                    });
                };

                getSettings = function () {
                    chrome.storage.sync.get('settings', function(storedSettings) {
                        if(!_.isUndefined(storedSettings.settings) && !_.isUndefined(storedSettings.settings.olxLink)) {
                            settings = storedSettings.settings;
                        }
                        getOldList();
                    });
                };

                checkIfNotToMuchData = function() {
                    if(list.length > 500) {
                        var tempList = [];
                        for(var i =0; i<500; i++) {
                            tempList.push(list[i]);
                        }
                        list = tempList;
                        chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                        setList(list);
                    }
                };

                getSettings();
                $interval(function() {
                    getDataFromOlx();
                    getDataFromGumtree();
                    checkIfNotToMuchData();
                }, settings.interval*60*1000);
            }]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tncm91bmQubW9kdWxlLmpzIiwiYmFja2dyb3VuZC5yb3V0ZS5qcyIsImJhY2tncm91bmRDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYmFja2dyb3VuZC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJywgW1xuICAgICAgICAndWkucm91dGVyJywgJ3JlbnRhbC1zZXJ2aWNlcydcbiAgICBdKVxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJylcbiAgICAgICAgLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIsICR1cmxSb3V0ZXJQcm92aWRlcikge1xuICAgICAgICAgICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuICAgICAgICAgICAgJHN0YXRlUHJvdmlkZXJcbiAgICAgICAgICAgICAgICAuc3RhdGUoJ2JhY2tncm91bmQnLCB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdiYWNrZ3JvdW5kJyxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnLycsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdCYWNrZ3JvdW5kQ29udHJvbGxlcidcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICB9KVxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0JhY2tncm91bmRDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGh0dHAnLCAnJGludGVydmFsJywgJ0xpbmtTZXJ2aWNlJyxcbiAgICAgICAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGh0dHAsICRpbnRlcnZhbCwgTGlua1NlcnZpY2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IDEsXG4gICAgICAgICAgICAgICAgICAgIG9seExpbms6ICdodHRwOi8vb2x4LnBsL25pZXJ1Y2hvbW9zY2kvbWllc3prYW5pYS93eW5hamVtLycsXG4gICAgICAgICAgICAgICAgICAgIGd1bXRyZWVMaW5rOiAnaHR0cDovL3d3dy5ndW10cmVlLnBsL3MtbWllc3prYW5pYS1pLWRvbXktZG8td3luYWplY2lhL3YxYzkwMDgnLFxuICAgICAgICAgICAgICAgICAgICBhZHZhbmNlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb3duZXI6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHByaWNlVG86IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHByaWNlRnJvbTogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgYXJlYVRvOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBhcmVhRnJvbTogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgYXV0b21hdGljYWxseU1hcmtBc1NlZW46IGZhbHNlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB2YXIgc2V0TGlzdCwgZ2V0RGF0YUZyb21PbHgsIGdldFVuc2VlbiwgZ2V0U2V0dGluZ3MsIHNldFNldHRpbmdzLCBwcmVwYXJlT2x4TGluayxcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlLCBnZXRPbGRMaXN0LCBjaGVja0lmTm90VG9NdWNoRGF0YTtcblxuICAgICAgICAgICAgICAgICRzY29wZS5jb3VudGVyID0gMDtcblxuICAgICAgICAgICAgICAgIGNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcihmdW5jdGlvbihyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlcXVlc3QuZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsaXN0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2V0dGluZ3MuYXV0b21hdGljYWxseU1hcmtBc1NlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGxpc3QsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zZWVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycrZ2V0VW5zZWVuKCkrJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzZXR0aW5ncyc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlcXVlc3Quc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzZWVuJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighXy5pc1VuZGVmaW5lZChyZXF1ZXN0LnNlZW4pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZmluZChsaXN0LCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQocmVxdWVzdC5zZWVuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycrZ2V0VW5zZWVuKCkrJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKCdTdWNjZXNzJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdhbGxTZWVuJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighXy5pc1VuZGVmaW5lZChyZXF1ZXN0LnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZWwudHlwZSA9PT0gcmVxdWVzdC50eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnK2dldFVuc2VlbigpKycnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldExpc3QobGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSgnU3VjY2VzcycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFNldHRpbmdzKHJlcXVlc3Quc2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBnZXRPbGRMaXN0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLmdldChmdW5jdGlvbihpdGVtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQoaXRlbS5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKCk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHNldExpc3QgPSBmdW5jdGlvbihlbGVtZW50cykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2x4RGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGVsZW1lbnRzLCBmdW5jdGlvbihlbGVtZW50LCBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2x4RGF0YVtpbmRleF0gPSBlbGVtZW50O1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuc2V0KG9seERhdGEsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTm90aWZ5IHRoYXQgd2Ugc2F2ZWQuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRVbnNlZW4gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG51bWJlck9mVW5zZWVuID0gMDtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKGxpc3QsIGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVsZW1lbnQuc2VlbiA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1iZXJPZlVuc2VlbisrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bWJlck9mVW5zZWVuO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXREYXRhRnJvbU9seCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2x4TGluayA9IHNldHRpbmdzLm9seExpbms7XG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5hZHZhbmNlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2x4TGluayA9IExpbmtTZXJ2aWNlLmdldE9seExpbmtCeVNldHRpbmdzKHNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAkaHR0cC5nZXQob2x4TGluaylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2l0ZSA9ICQoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldmVyc2VkVGVtcERhdGEgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXRlLmZpbmQoJyNvZmZlcnNfdGFibGUnKS5maW5kKCd0ciB0ZC5vZmZlcicpLmVhY2goZnVuY3Rpb24oaW5kZXgsIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQoJChlbGVtZW50KS5maW5kKCcub2JzZXJ2ZWxpbmtpbmZvIGEnKS5hdHRyKCdjbGFzcycpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gJChlbGVtZW50KS5maW5kKCcub2JzZXJ2ZWxpbmtpbmZvIGEnKS5hdHRyKCdjbGFzcycpLnNwbGl0KCcgJylbMF0ucmVwbGFjZSgvaWR8Onx9fHsvZ20sJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoXy5pc1VuZGVmaW5lZChfLmZpbmQobGlzdCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQoaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldmVyc2VkVGVtcERhdGEudW5zaGlmdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hJZDogcGFyc2VJbnQoaWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmljZTogXy50cmltKCQoZWxlbWVudCkuZmluZCgnLnRkLXByaWNlIC5jMDAwJykuaHRtbCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJChlbGVtZW50KS5maW5kKCcubGlua1dpdGhIYXNoIHN0cm9uZycpLmh0bWwoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluazogJChlbGVtZW50KS5maW5kKCcubGlua1dpdGhIYXNoJykuYXR0cignaHJlZicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWc6ICQoZWxlbWVudCkuZmluZCgnLmxpbmtXaXRoSGFzaCBpbWcnKS5hdHRyKCdzcmMnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VlbjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdvbHgnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmZvckVhY2gocmV2ZXJzZWRUZW1wRGF0YSwgZnVuY3Rpb24oZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnVuc2hpZnQoZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnK2dldFVuc2VlbigpKycnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLlxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSxzdGF0dXMsaGVhZGVycyxjb25maWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgOignLCBzdGF0dXMsIGNvbmZpZywgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBndW10cmVlTGluayA9IHNldHRpbmdzLmd1bXRyZWVMaW5rO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZXR0aW5ncy5hZHZhbmNlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3VtdHJlZUxpbmsgPSBMaW5rU2VydmljZS5nZXRHdW10cmVlTGlua0J5U2V0dGluZ3Moc2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIGNhbm5vdCB1c2UgJGh0dHAuanNvbnAoKSBiZWNhdXNlIG9mIENvbnRlbnQgU2VjdXJpdHkgUG9saWN5XG4gICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaT0xOyBpPDY7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VMaW5rID0gZ3VtdHJlZUxpbms7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihpPjEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlTGluayA9IGd1bXRyZWVMaW5rLnNwbGl0KCdwMT8nKVswXSsncCcraSsnPydcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArZ3VtdHJlZUxpbmsuc3BsaXQoJ3AxPycpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgJGh0dHAuZ2V0KHBhZ2VMaW5rKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlZWQgPSAkKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV2ZXJzZWRUZW1wRGF0YSA9IFtdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlZWQuZmluZCgnLnZpZXc6bm90KC50b3AtbGlzdGluZ3MpJykuZmluZCgndWwgbGkucmVzdWx0JykuZWFjaChmdW5jdGlvbihpbmRleCwgZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gJChlbGVtZW50KS5maW5kKCcuYWRkQWRUb2ZhdicpLmF0dHIoJ2RhdGEtYWRpZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoXy5pc1VuZGVmaW5lZChfLmZpbmQobGlzdCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQoaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKSAmJiAhXy5pc1VuZGVmaW5lZChpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXZlcnNlZFRlbXBEYXRhLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoSWQ6IHBhcnNlSW50KGlkKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2U6IF8udHJpbSgkKGVsZW1lbnQpLmZpbmQoJy5wcmljZSAuYW1vdW50JykuaHRtbCgpLnJlcGxhY2UoJyZuYnNwOycsICcgJykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBfLnRyaW0oJChlbGVtZW50KS5maW5kKCcuaHJlZi1saW5rJykudGV4dCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluazogJ2h0dHA6Ly93d3cuZ3VtdHJlZS5wbCcrJChlbGVtZW50KS5maW5kKCcuaHJlZi1saW5rJykuYXR0cignaHJlZicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWc6ICQoZWxlbWVudCkuZmluZCgnI2ltZy1jbnQgaW1nJykuYXR0cignc3JjJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZW46IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZ3VtdHJlZSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoKHJldmVyc2VkVGVtcERhdGEsIGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QudW5zaGlmdChlbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsc3RhdHVzLGhlYWRlcnMsY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6KCcsIHN0YXR1cywgY29uZmlnLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBzZXRTZXR0aW5ncyA9IGZ1bmN0aW9uIChzZXR0aW5ncykge1xuICAgICAgICAgICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5zeW5jLnNldCh7c2V0dGluZ3M6IHNldHRpbmdzfSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIG5vdGlmeSB0aGF0IHNldHRpbmdzIGhhcyBiZWVuIHNhdmVkLlxuICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuY2xlYXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFNldHRpbmdzKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRTZXR0aW5ncyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2Uuc3luYy5nZXQoJ3NldHRpbmdzJywgZnVuY3Rpb24oc3RvcmVkU2V0dGluZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFfLmlzVW5kZWZpbmVkKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzKSAmJiAhXy5pc1VuZGVmaW5lZChzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5vbHhMaW5rKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzID0gc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3M7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBnZXRPbGRMaXN0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZihsaXN0Lmxlbmd0aCA+IDUwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBMaXN0ID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPTA7IGk8NTAwOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wTGlzdC5wdXNoKGxpc3RbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCA9IHRlbXBMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRTZXR0aW5ncygpO1xuICAgICAgICAgICAgICAgICRpbnRlcnZhbChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrSWZOb3RUb011Y2hEYXRhKCk7XG4gICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MuaW50ZXJ2YWwqNjAqMTAwMCk7XG4gICAgICAgICAgICB9XSk7XG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==