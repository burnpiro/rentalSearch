(function () {
    angular.module('RentalBackgroundApp', [
        'ui.router', 'rental-services'
    ])
})();
(function () {
    angular.module('RentalBackgroundApp')
        .config(function ($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/');
            $stateProvider
                .state('background', {
                    name: 'background',
                    url: '/',
                    controller: 'BackgroundController'
                })
        })
})();
(function () {
    angular.module('RentalBackgroundApp')
        .controller('BackgroundController', ['$scope', '$http', '$interval', 'LinkService',
            function($scope, $http, $interval, LinkService) {
                var list = [];
                var settings = {
                    interval: 1,
                    olxLink: 'http://olx.pl/nieruchomosci/mieszkania/wynajem/',
                    gumtreeLink: 'http://www.gumtree.pl/f-SearchAdRss?CatId=9008&Location=202',
                    gumtreeLinkOriginal: 'http://www.gumtree.pl/fp-mieszkania-i-domy-do-wynajecia/c9008l202 ',
                    advanced: true,
                    location: {
                        display: '',
                        name: '',
                        value: ''
                    },
                    owner: null,
                    priceTo: null,
                    priceFrom: null,
                    areaTo: null,
                    areaFrom: null,
                    automaticallyMarkAsSeen: false
                };
                var setList, getDataFromOlx, getUnseen, getSettings, setSettings, prepareOlxLink,
                    getDataFromGumtree, getOldList, checkIfNotToMuchData;

                $scope.counter = 0;

                chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
                    switch (request.get) {
                        case 'list':
                            sendResponse(list);
                            if(settings.automaticallyMarkAsSeen) {
                                _.forEach(list, function(el) {
                                    el.seen = true;
                                });
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            }
                            break;
                        case 'settings':
                            sendResponse(settings);
                            break;
                    }
                    switch (request.set) {
                        case 'seen':
                            if(!_.isUndefined(request.seen)) {
                                if(request.type === 'olx') {
                                    _.find(list, function(el) {
                                        return el.hashId === parseInt(request.seen);
                                    }).seen = true;
                                } else if(request.type === 'gumtree') {
                                    _.find(list, function(el) {
                                        return el.id === parseInt(request.seen);
                                    }).seen = true;
                                }
                                chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                                setList(list);
                            }
                            sendResponse('Success');
                            break;
                        case 'settings':
                            setSettings(request.settings);
                            break;
                    }
                });

                getOldList = function() {
                    chrome.storage.local.get(function(items) {
                        _.forEach(items, function(item) {
                            if(!_.isUndefined(item.id)) {
                                list.push(item);
                            }
                        });
                    });
                    getDataFromOlx();
                    getDataFromGumtree();
                };

                setList = function(elements) {
                    var olxData = {
                    };
                    _.forEach(elements, function(element, index) {
                        olxData[index] = element;
                    });
                    chrome.storage.local.set(olxData, function() {
                        // Notify that we saved.
                    });
                };

                getUnseen = function() {
                    var numberOfUnseen = 0;
                    _.forEach(list, function(element) {
                        if(element.seen === false) {
                            numberOfUnseen++;
                        }
                    });
                    return numberOfUnseen;
                };

                getDataFromOlx = function() {
                    var olxLink = settings.olxLink;
                    if(!settings.advanced) {
                        olxLink = LinkService.getOlxLinkBySettings(settings);
                    }
                    $http.get(olxLink)
                        .success(function(data) {
                            var site = $(data);
                            var reversedTempData = [];
                            site.find('#offers_table').find('tr td.offer').each(function(index, element) {
                                if(!_.isUndefined($(element).find('.observelinkinfo a').attr('class'))) {
                                    var id = $(element).find('.observelinkinfo a').attr('class').split(' ')[0].replace(/id|:|}|{/gm,'');
                                    if(_.isUndefined(_.find(list, function(el) {
                                            return el.hashId === parseInt(id);
                                        }))) {
                                        reversedTempData.unshift({
                                            hashId: parseInt(id),
                                            date: new Date(),
                                            price: _.trim($(element).find('.td-price .c000').html()),
                                            name: $(element).find('.linkWithHash span').html(),
                                            link: $(element).find('.linkWithHash').attr('href'),
                                            img: $(element).find('.linkWithHash img').attr('src'),
                                            seen: false,
                                            type: 'olx'
                                        });
                                    }
                                }
                            });
                            _.forEach(reversedTempData, function(element) {
                                list.unshift(element);
                            });

                            chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            setList(list);
                        }).
                        error(function(data,status,headers,config) {
                            console.log('error :(', status, config, data);
                        });
                };

                getDataFromGumtree = function() {
                    var gumtreeLink = settings.gumtreeLink;

                    if(!settings.advanced) {
                        gumtreeLink = LinkService.getGumtreeLinkBySettings(settings);
                    }
                    // cannot use $http.jsonp() because of Content Security Policy
                    $http.get(gumtreeLink)
                        .success(function(data) {
                            var feed = $(data);

                            feed.find('item').each(function(index, element) {
                                var gumtreeElement = {
                                    name: _.trim($(element).find('title').text()),
                                    link: $(element).find('guid').html(),
                                    date: _.trim($(element).find("pubdate").html()),
                                    id: parseInt((new Date(_.trim($(element).find("pubdate").html()))).valueOf()),
                                    seen: false,
                                    type: 'gumtree'
                                };
                                if(_.isUndefined(_.find(list, { 'type': 'gumtree', 'id': gumtreeElement.id }))) {
                                    list.unshift(gumtreeElement);
                                }
                            });

                            chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                            setList(list);
                        }).
                        error(function(data,status,headers,config) {
                            console.log('error :(', status, config, data);
                        });
                };

                setSettings = function (settings) {
                    chrome.storage.sync.set({settings: settings}, function() {
                        // No need to notify that settings has been saved.
                        chrome.storage.local.clear();
                        list = [];
                        getSettings();
                    });
                };

                getSettings = function () {
                    chrome.storage.sync.get('settings', function(storedSettings) {
                        if(!_.isUndefined(storedSettings.settings) && !_.isUndefined(storedSettings.settings.olxLink)) {
                            settings = storedSettings.settings;
                        }
                        getOldList();
                    });
                };

                checkIfNotToMuchData = function() {
                    if(list.length > 500) {
                        var tempList = [];
                        for(var i =0; i<500; i++) {
                            tempList.push(list[i]);
                        }
                        list = tempList;
                        chrome.browserAction.setBadgeText({text: ''+getUnseen()+''});
                        setList(list);
                    }
                };

                getSettings();
                $interval(function() {
                    getDataFromOlx();
                    getDataFromGumtree();
                    checkIfNotToMuchData();
                }, settings.interval*60*1000);
            }]);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tncm91bmQubW9kdWxlLmpzIiwiYmFja2dyb3VuZC5yb3V0ZS5qcyIsImJhY2tncm91bmRDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYmFja2dyb3VuZC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJywgW1xuICAgICAgICAndWkucm91dGVyJywgJ3JlbnRhbC1zZXJ2aWNlcydcbiAgICBdKVxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJylcbiAgICAgICAgLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIsICR1cmxSb3V0ZXJQcm92aWRlcikge1xuICAgICAgICAgICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuICAgICAgICAgICAgJHN0YXRlUHJvdmlkZXJcbiAgICAgICAgICAgICAgICAuc3RhdGUoJ2JhY2tncm91bmQnLCB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdiYWNrZ3JvdW5kJyxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiAnLycsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdCYWNrZ3JvdW5kQ29udHJvbGxlcidcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICB9KVxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIGFuZ3VsYXIubW9kdWxlKCdSZW50YWxCYWNrZ3JvdW5kQXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0JhY2tncm91bmRDb250cm9sbGVyJywgWyckc2NvcGUnLCAnJGh0dHAnLCAnJGludGVydmFsJywgJ0xpbmtTZXJ2aWNlJyxcbiAgICAgICAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGh0dHAsICRpbnRlcnZhbCwgTGlua1NlcnZpY2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWw6IDEsXG4gICAgICAgICAgICAgICAgICAgIG9seExpbms6ICdodHRwOi8vb2x4LnBsL25pZXJ1Y2hvbW9zY2kvbWllc3prYW5pYS93eW5hamVtLycsXG4gICAgICAgICAgICAgICAgICAgIGd1bXRyZWVMaW5rOiAnaHR0cDovL3d3dy5ndW10cmVlLnBsL2YtU2VhcmNoQWRSc3M/Q2F0SWQ9OTAwOCZMb2NhdGlvbj0yMDInLFxuICAgICAgICAgICAgICAgICAgICBndW10cmVlTGlua09yaWdpbmFsOiAnaHR0cDovL3d3dy5ndW10cmVlLnBsL2ZwLW1pZXN6a2FuaWEtaS1kb215LWRvLXd5bmFqZWNpYS9jOTAwOGwyMDIgJyxcbiAgICAgICAgICAgICAgICAgICAgYWR2YW5jZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG93bmVyOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBwcmljZVRvOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBwcmljZUZyb206IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGFyZWFUbzogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgYXJlYUZyb206IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGF1dG9tYXRpY2FsbHlNYXJrQXNTZWVuOiBmYWxzZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdmFyIHNldExpc3QsIGdldERhdGFGcm9tT2x4LCBnZXRVbnNlZW4sIGdldFNldHRpbmdzLCBzZXRTZXR0aW5ncywgcHJlcGFyZU9seExpbmssXG4gICAgICAgICAgICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSwgZ2V0T2xkTGlzdCwgY2hlY2tJZk5vdFRvTXVjaERhdGE7XG5cbiAgICAgICAgICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7XG5cbiAgICAgICAgICAgICAgICBjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UuYWRkTGlzdGVuZXIoZnVuY3Rpb24ocmVxdWVzdCwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChyZXF1ZXN0LmdldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNldHRpbmdzLmF1dG9tYXRpY2FsbHlNYXJrQXNTZWVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuYnJvd3NlckFjdGlvbi5zZXRCYWRnZVRleHQoe3RleHQ6ICcnK2dldFVuc2VlbigpKycnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZShzZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChyZXF1ZXN0LnNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2Vlbic6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIV8uaXNVbmRlZmluZWQocmVxdWVzdC5zZWVuKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXF1ZXN0LnR5cGUgPT09ICdvbHgnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmZpbmQobGlzdCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuaGFzaElkID09PSBwYXJzZUludChyZXF1ZXN0LnNlZW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihyZXF1ZXN0LnR5cGUgPT09ICdndW10cmVlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5maW5kKGxpc3QsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmlkID09PSBwYXJzZUludChyZXF1ZXN0LnNlZW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuc2VlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoJ1N1Y2Nlc3MnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NldHRpbmdzJzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRTZXR0aW5ncyhyZXF1ZXN0LnNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZ2V0T2xkTGlzdCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoZnVuY3Rpb24oaXRlbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFfLmlzVW5kZWZpbmVkKGl0ZW0uaWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGdldERhdGFGcm9tT2x4KCk7XG4gICAgICAgICAgICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSgpO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBzZXRMaXN0ID0gZnVuY3Rpb24oZWxlbWVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9seERhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9seERhdGFbaW5kZXhdID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldChvbHhEYXRhLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdGlmeSB0aGF0IHdlIHNhdmVkLlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgZ2V0VW5zZWVuID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZlVuc2VlbiA9IDA7XG4gICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihlbGVtZW50LnNlZW4gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyT2ZVbnNlZW4rKztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudW1iZXJPZlVuc2VlbjtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21PbHggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9seExpbmsgPSBzZXR0aW5ncy5vbHhMaW5rO1xuICAgICAgICAgICAgICAgICAgICBpZighc2V0dGluZ3MuYWR2YW5jZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9seExpbmsgPSBMaW5rU2VydmljZS5nZXRPbHhMaW5rQnlTZXR0aW5ncyhzZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgJGh0dHAuZ2V0KG9seExpbmspXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNpdGUgPSAkKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXZlcnNlZFRlbXBEYXRhID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l0ZS5maW5kKCcjb2ZmZXJzX3RhYmxlJykuZmluZCgndHIgdGQub2ZmZXInKS5lYWNoKGZ1bmN0aW9uKGluZGV4LCBlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFfLmlzVW5kZWZpbmVkKCQoZWxlbWVudCkuZmluZCgnLm9ic2VydmVsaW5raW5mbyBhJykuYXR0cignY2xhc3MnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9ICQoZWxlbWVudCkuZmluZCgnLm9ic2VydmVsaW5raW5mbyBhJykuYXR0cignY2xhc3MnKS5zcGxpdCgnICcpWzBdLnJlcGxhY2UoL2lkfDp8fXx7L2dtLCcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF8uaXNVbmRlZmluZWQoXy5maW5kKGxpc3QsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5oYXNoSWQgPT09IHBhcnNlSW50KGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXZlcnNlZFRlbXBEYXRhLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoSWQ6IHBhcnNlSW50KGlkKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2U6IF8udHJpbSgkKGVsZW1lbnQpLmZpbmQoJy50ZC1wcmljZSAuYzAwMCcpLmh0bWwoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICQoZWxlbWVudCkuZmluZCgnLmxpbmtXaXRoSGFzaCBzcGFuJykuaHRtbCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiAkKGVsZW1lbnQpLmZpbmQoJy5saW5rV2l0aEhhc2gnKS5hdHRyKCdocmVmJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltZzogJChlbGVtZW50KS5maW5kKCcubGlua1dpdGhIYXNoIGltZycpLmF0dHIoJ3NyYycpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ29seCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChyZXZlcnNlZFRlbXBEYXRhLCBmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QudW5zaGlmdChlbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycrZ2V0VW5zZWVuKCkrJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSkuXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLHN0YXR1cyxoZWFkZXJzLGNvbmZpZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6KCcsIHN0YXR1cywgY29uZmlnLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXREYXRhRnJvbUd1bXRyZWUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGd1bXRyZWVMaW5rID0gc2V0dGluZ3MuZ3VtdHJlZUxpbms7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoIXNldHRpbmdzLmFkdmFuY2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBndW10cmVlTGluayA9IExpbmtTZXJ2aWNlLmdldEd1bXRyZWVMaW5rQnlTZXR0aW5ncyhzZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gY2Fubm90IHVzZSAkaHR0cC5qc29ucCgpIGJlY2F1c2Ugb2YgQ29udGVudCBTZWN1cml0eSBQb2xpY3lcbiAgICAgICAgICAgICAgICAgICAgJGh0dHAuZ2V0KGd1bXRyZWVMaW5rKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmZWVkID0gJChkYXRhKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlZWQuZmluZCgnaXRlbScpLmVhY2goZnVuY3Rpb24oaW5kZXgsIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGd1bXRyZWVFbGVtZW50ID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXy50cmltKCQoZWxlbWVudCkuZmluZCgndGl0bGUnKS50ZXh0KCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluazogJChlbGVtZW50KS5maW5kKCdndWlkJykuaHRtbCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZTogXy50cmltKCQoZWxlbWVudCkuZmluZChcInB1YmRhdGVcIikuaHRtbCgpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBwYXJzZUludCgobmV3IERhdGUoXy50cmltKCQoZWxlbWVudCkuZmluZChcInB1YmRhdGVcIikuaHRtbCgpKSkpLnZhbHVlT2YoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdndW10cmVlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihfLmlzVW5kZWZpbmVkKF8uZmluZChsaXN0LCB7ICd0eXBlJzogJ2d1bXRyZWUnLCAnaWQnOiBndW10cmVlRWxlbWVudC5pZCB9KSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QudW5zaGlmdChndW10cmVlRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycrZ2V0VW5zZWVuKCkrJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSkuXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihmdW5jdGlvbihkYXRhLHN0YXR1cyxoZWFkZXJzLGNvbmZpZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6KCcsIHN0YXR1cywgY29uZmlnLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBzZXRTZXR0aW5ncyA9IGZ1bmN0aW9uIChzZXR0aW5ncykge1xuICAgICAgICAgICAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5zeW5jLnNldCh7c2V0dGluZ3M6IHNldHRpbmdzfSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIG5vdGlmeSB0aGF0IHNldHRpbmdzIGhhcyBiZWVuIHNhdmVkLlxuICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuY2xlYXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdldFNldHRpbmdzKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRTZXR0aW5ncyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2Uuc3luYy5nZXQoJ3NldHRpbmdzJywgZnVuY3Rpb24oc3RvcmVkU2V0dGluZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFfLmlzVW5kZWZpbmVkKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzKSAmJiAhXy5pc1VuZGVmaW5lZChzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5vbHhMaW5rKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzID0gc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3M7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBnZXRPbGRMaXN0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZihsaXN0Lmxlbmd0aCA+IDUwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBMaXN0ID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPTA7IGk8NTAwOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wTGlzdC5wdXNoKGxpc3RbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdCA9IHRlbXBMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJytnZXRVbnNlZW4oKSsnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0TGlzdChsaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBnZXRTZXR0aW5ncygpO1xuICAgICAgICAgICAgICAgICRpbnRlcnZhbChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKTtcbiAgICAgICAgICAgICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrSWZOb3RUb011Y2hEYXRhKCk7XG4gICAgICAgICAgICAgICAgfSwgc2V0dGluZ3MuaW50ZXJ2YWwqNjAqMTAwMCk7XG4gICAgICAgICAgICB9XSk7XG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==