(function () {
    angular.module('RentalBackgroundApp', [
        'ui.router', 'rental-services'
    ])
})();
(function () {
    angular.module('RentalBackgroundApp')
        .config(function ($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/');
            $stateProvider
                .state('background', {
                    name: 'background',
                    url: '/',
                    controller: 'BackgroundController'
                })
        })
})();
(function () {
  angular.module('RentalBackgroundApp')
    .controller('BackgroundController', ['$scope', '$http', '$interval', 'LinkService',
      function ($scope, $http, $interval, LinkService) {
        var list = []
        var settings = {
          interval: 1,
          olxLink: [
            'http://olx.pl/nieruchomosci/mieszkania/wynajem/'
          ],
          gumtreeLink: [
            'http://www.gumtree.pl/s-mieszkania-i-domy-do-wynajecia/v1c9008'
          ],
          advanced: true,
          location: {
            display: '',
            name: '',
            value: ''
          },
          owner: null,
          priceTo: null,
          priceFrom: null,
          areaTo: null,
          areaFrom: null,
          automaticallyMarkAsSeen: false
        }
        var setList, getDataFromOlx, getUnseen, getSettings, setSettings, prepareOlxLink,
          getDataFromGumtree, getOldList, checkIfNotToMuchData

        $scope.counter = 0

        chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
          switch (request.get) {
            case 'list':
              sendResponse(list)
              if (settings.automaticallyMarkAsSeen) {
                _.forEach(list, function (el) {
                  el.seen = true
                })
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
              }
              break
            case 'settings':
              sendResponse(settings)
              break
          }
          switch (request.set) {
            case 'seen':
              if (!_.isUndefined(request.seen)) {
                _.find(list, function (el) {
                  return el.hashId === parseInt(request.seen)
                }).seen = true
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }
              sendResponse('Success')
              break
            case 'allSeen':
              if (!_.isUndefined(request.type)) {
                _.forEach(list, function (el) {
                  if (el.type === request.type) {
                    el.seen = true
                  }
                })
                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }
              sendResponse('Success')
              break
            case 'settings':
              setSettings(request.settings)
              break
          }
        })

        getOldList = function () {
          chrome.storage.local.get(function (items) {
            _.forEach(items, function (item) {
              if (!_.isUndefined(item.id)) {
                list.push(item)
              }
            })
          })
          getDataFromOlx()
          getDataFromGumtree()
        }

        setList = function (elements) {
          var olxData = {}
          _.forEach(elements, function (element, index) {
            olxData[index] = element
          })
          chrome.storage.local.set(olxData, function () {
            // Notify that we saved.
          })
        }

        getUnseen = function () {
          var numberOfUnseen = 0
          _.forEach(list, function (element) {
            if (element.seen === false) {
              numberOfUnseen++
            }
          })
          return numberOfUnseen
        }

        getDataFromOlx = function () {
          var olxLink = settings.olxLink
          if (!settings.advanced) {
            olxLink = LinkService.getOlxLinkBySettings(settings)
          }
          if (!olxLink) {
            return false
          }

          olxLink.forEach(function (link) {
            if (!link) {
              return
            }
            $http.get(link)
              .success(function (data) {
                var site = $(data)
                var reversedTempData = []
                site.find('#offers_table').find('tr td.offer').each(function (index, element) {
                  if (!_.isUndefined($(element).find('.observelinkinfo a').attr('class'))) {
                    var id = $(element).find('.observelinkinfo a').attr('class').split(' ')[0].replace(/id|:|}|{/gm, '')
                    if (_.isUndefined(_.find(list, function (el) {
                        return el.hashId === parseInt(id)
                      }))) {
                      reversedTempData.unshift({
                        hashId: parseInt(id),
                        date: new Date(),
                        price: _.trim($(element).find('p.price strong').html()),
                        name: $(element).find('.linkWithHash strong').html(),
                        link: $(element).find('.linkWithHash').attr('href'),
                        img: $(element).find('.linkWithHash img').attr('src'),
                        seen: false,
                        type: 'olx'
                      })
                    }
                  }
                })
                _.forEach(reversedTempData, function (element) {
                  list.unshift(element)
                })

                chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                setList(list)
              }).error(function (data, status, headers, config) {
              console.log('error :(')
            })
          })
        }

        getDataFromGumtree = function () {
          var gumtreeLink = settings.gumtreeLink

          if (!settings.advanced) {
            gumtreeLink = LinkService.getGumtreeLinkBySettings(settings)
          }
          // cannot use $http.jsonp() because of Content Security Policy
          if (!gumtreeLink) {
            return false
          }

          gumtreeLink.forEach(function (link) {
            if (!link) {
              return
            }
            for (var i = 1; i < 6; i++) {
              var pageLink = link
              if (i > 1) {
                pageLink = link.split('p1?')[1] ? (link.split('p1?')[0] + 'p' + i + '?'
                + link.split('p1?')[1]) : link
              }
              if (i > 2 && link.indexOf('p1?') === -1) {
                return
              }
              $http.get(pageLink)
                .success(function (data) {
                  var feed = $(data)
                  var reversedTempData = []

                  feed.find('.view:not(.top-listings)').find('ul li.result').each(function (index, element) {
                    var id = $(element).find('.addAdTofav').attr('data-adid')
                    if (_.isUndefined(_.find(list, function (el) {
                        return el.hashId === parseInt(id)
                      })) && !_.isUndefined(id)) {
                      reversedTempData.unshift({
                        hashId: parseInt(id),
                        price: _.trim($(element).find('.price .amount').html().replace('&nbsp;', ' ')),
                        name: _.trim($(element).find('.href-link').text()),
                        link: 'http://www.gumtree.pl' + $(element).find('.href-link').attr('href'),
                        img: $(element).find('#img-cnt img').attr('src'),
                        date: new Date(),
                        seen: false,
                        type: 'gumtree'
                      })
                    }
                  })

                  _.forEach(reversedTempData, function (element) {
                    list.unshift(element)
                  })

                  chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
                  setList(list)
                }).error(function (data, status, headers, config) {
                console.log('error :(')
              })
            }
          })
        }

        setSettings = function (settings) {
          chrome.storage.sync.set({settings: settings}, function () {
            // No need to notify that settings has been saved.
            chrome.storage.local.clear()
            list = []
            getSettings()
          })
        }

        getSettings = function () {
          chrome.storage.sync.get('settings', function (storedSettings) {
            if (!_.isUndefined(storedSettings.settings) && !_.isUndefined(storedSettings.settings.olxLink)) {
              if (typeof storedSettings.settings.olxLink === 'string') {
                storedSettings.settings.olxLink = [
                  storedSettings.settings.olxLink
                ]
              }
              if (typeof storedSettings.settings.gumtreeLink === 'string') {
                storedSettings.settings.gumtreeLink = [
                  storedSettings.settings.gumtreeLink
                ]
              }
              settings = storedSettings.settings
            }
            getOldList()
          })
        }

        checkIfNotToMuchData = function () {
          if (list.length > 500) {
            var tempList = []
            for (var i = 0; i < 500; i++) {
              tempList.push(list[i])
            }
            list = tempList
            chrome.browserAction.setBadgeText({text: '' + getUnseen() + ''})
            setList(list)
          }
        }

        getSettings()
        $interval(function () {
          getDataFromOlx()
          getDataFromGumtree()
          checkIfNotToMuchData()
        }, settings.interval * 60 * 1000)
      }])
})()
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2tncm91bmQubW9kdWxlLmpzIiwiYmFja2dyb3VuZC5yb3V0ZS5qcyIsImJhY2tncm91bmRDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImJhY2tncm91bmQubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcbiAgICBhbmd1bGFyLm1vZHVsZSgnUmVudGFsQmFja2dyb3VuZEFwcCcsIFtcbiAgICAgICAgJ3VpLnJvdXRlcicsICdyZW50YWwtc2VydmljZXMnXG4gICAgXSlcbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcbiAgICBhbmd1bGFyLm1vZHVsZSgnUmVudGFsQmFja2dyb3VuZEFwcCcpXG4gICAgICAgIC5jb25maWcoZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyLCAkdXJsUm91dGVyUHJvdmlkZXIpIHtcbiAgICAgICAgICAgICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy8nKTtcbiAgICAgICAgICAgICRzdGF0ZVByb3ZpZGVyXG4gICAgICAgICAgICAgICAgLnN0YXRlKCdiYWNrZ3JvdW5kJywge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnYmFja2dyb3VuZCcsXG4gICAgICAgICAgICAgICAgICAgIHVybDogJy8nLFxuICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnQmFja2dyb3VuZENvbnRyb2xsZXInXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcbiAgYW5ndWxhci5tb2R1bGUoJ1JlbnRhbEJhY2tncm91bmRBcHAnKVxuICAgIC5jb250cm9sbGVyKCdCYWNrZ3JvdW5kQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRodHRwJywgJyRpbnRlcnZhbCcsICdMaW5rU2VydmljZScsXG4gICAgICBmdW5jdGlvbiAoJHNjb3BlLCAkaHR0cCwgJGludGVydmFsLCBMaW5rU2VydmljZSkge1xuICAgICAgICB2YXIgbGlzdCA9IFtdXG4gICAgICAgIHZhciBzZXR0aW5ncyA9IHtcbiAgICAgICAgICBpbnRlcnZhbDogMSxcbiAgICAgICAgICBvbHhMaW5rOiBbXG4gICAgICAgICAgICAnaHR0cDovL29seC5wbC9uaWVydWNob21vc2NpL21pZXN6a2FuaWEvd3luYWplbS8nXG4gICAgICAgICAgXSxcbiAgICAgICAgICBndW10cmVlTGluazogW1xuICAgICAgICAgICAgJ2h0dHA6Ly93d3cuZ3VtdHJlZS5wbC9zLW1pZXN6a2FuaWEtaS1kb215LWRvLXd5bmFqZWNpYS92MWM5MDA4J1xuICAgICAgICAgIF0sXG4gICAgICAgICAgYWR2YW5jZWQ6IHRydWUsXG4gICAgICAgICAgbG9jYXRpb246IHtcbiAgICAgICAgICAgIGRpc3BsYXk6ICcnLFxuICAgICAgICAgICAgbmFtZTogJycsXG4gICAgICAgICAgICB2YWx1ZTogJydcbiAgICAgICAgICB9LFxuICAgICAgICAgIG93bmVyOiBudWxsLFxuICAgICAgICAgIHByaWNlVG86IG51bGwsXG4gICAgICAgICAgcHJpY2VGcm9tOiBudWxsLFxuICAgICAgICAgIGFyZWFUbzogbnVsbCxcbiAgICAgICAgICBhcmVhRnJvbTogbnVsbCxcbiAgICAgICAgICBhdXRvbWF0aWNhbGx5TWFya0FzU2VlbjogZmFsc2VcbiAgICAgICAgfVxuICAgICAgICB2YXIgc2V0TGlzdCwgZ2V0RGF0YUZyb21PbHgsIGdldFVuc2VlbiwgZ2V0U2V0dGluZ3MsIHNldFNldHRpbmdzLCBwcmVwYXJlT2x4TGluayxcbiAgICAgICAgICBnZXREYXRhRnJvbUd1bXRyZWUsIGdldE9sZExpc3QsIGNoZWNrSWZOb3RUb011Y2hEYXRhXG5cbiAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwXG5cbiAgICAgICAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKGZ1bmN0aW9uIChyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkge1xuICAgICAgICAgIHN3aXRjaCAocmVxdWVzdC5nZXQpIHtcbiAgICAgICAgICAgIGNhc2UgJ2xpc3QnOlxuICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UobGlzdClcbiAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmF1dG9tYXRpY2FsbHlNYXJrQXNTZWVuKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JFYWNoKGxpc3QsIGZ1bmN0aW9uIChlbCkge1xuICAgICAgICAgICAgICAgICAgZWwuc2VlbiA9IHRydWVcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycgKyBnZXRVbnNlZW4oKSArICcnfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSAnc2V0dGluZ3MnOlxuICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoc2V0dGluZ3MpXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgICAgIHN3aXRjaCAocmVxdWVzdC5zZXQpIHtcbiAgICAgICAgICAgIGNhc2UgJ3NlZW4nOlxuICAgICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQocmVxdWVzdC5zZWVuKSkge1xuICAgICAgICAgICAgICAgIF8uZmluZChsaXN0LCBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5oYXNoSWQgPT09IHBhcnNlSW50KHJlcXVlc3Quc2VlbilcbiAgICAgICAgICAgICAgICB9KS5zZWVuID0gdHJ1ZVxuICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycgKyBnZXRVbnNlZW4oKSArICcnfSlcbiAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKCdTdWNjZXNzJylcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGNhc2UgJ2FsbFNlZW4nOlxuICAgICAgICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQocmVxdWVzdC50eXBlKSkge1xuICAgICAgICAgICAgICAgIF8uZm9yRWFjaChsaXN0LCBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChlbC50eXBlID09PSByZXF1ZXN0LnR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZWwuc2VlbiA9IHRydWVcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycgKyBnZXRVbnNlZW4oKSArICcnfSlcbiAgICAgICAgICAgICAgICBzZXRMaXN0KGxpc3QpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKCdTdWNjZXNzJylcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGNhc2UgJ3NldHRpbmdzJzpcbiAgICAgICAgICAgICAgc2V0U2V0dGluZ3MocmVxdWVzdC5zZXR0aW5ncylcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgZ2V0T2xkTGlzdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBjaHJvbWUuc3RvcmFnZS5sb2NhbC5nZXQoZnVuY3Rpb24gKGl0ZW1zKSB7XG4gICAgICAgICAgICBfLmZvckVhY2goaXRlbXMsIGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChpdGVtLmlkKSkge1xuICAgICAgICAgICAgICAgIGxpc3QucHVzaChpdGVtKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgICAgZ2V0RGF0YUZyb21PbHgoKVxuICAgICAgICAgIGdldERhdGFGcm9tR3VtdHJlZSgpXG4gICAgICAgIH1cblxuICAgICAgICBzZXRMaXN0ID0gZnVuY3Rpb24gKGVsZW1lbnRzKSB7XG4gICAgICAgICAgdmFyIG9seERhdGEgPSB7fVxuICAgICAgICAgIF8uZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICAgICAgICBvbHhEYXRhW2luZGV4XSA9IGVsZW1lbnRcbiAgICAgICAgICB9KVxuICAgICAgICAgIGNocm9tZS5zdG9yYWdlLmxvY2FsLnNldChvbHhEYXRhLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBOb3RpZnkgdGhhdCB3ZSBzYXZlZC5cbiAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgZ2V0VW5zZWVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHZhciBudW1iZXJPZlVuc2VlbiA9IDBcbiAgICAgICAgICBfLmZvckVhY2gobGlzdCwgZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50LnNlZW4gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgIG51bWJlck9mVW5zZWVuKytcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIHJldHVybiBudW1iZXJPZlVuc2VlblxuICAgICAgICB9XG5cbiAgICAgICAgZ2V0RGF0YUZyb21PbHggPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgdmFyIG9seExpbmsgPSBzZXR0aW5ncy5vbHhMaW5rXG4gICAgICAgICAgaWYgKCFzZXR0aW5ncy5hZHZhbmNlZCkge1xuICAgICAgICAgICAgb2x4TGluayA9IExpbmtTZXJ2aWNlLmdldE9seExpbmtCeVNldHRpbmdzKHNldHRpbmdzKVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIW9seExpbmspIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgIH1cblxuICAgICAgICAgIG9seExpbmsuZm9yRWFjaChmdW5jdGlvbiAobGluaykge1xuICAgICAgICAgICAgaWYgKCFsaW5rKSB7XG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgJGh0dHAuZ2V0KGxpbmspXG4gICAgICAgICAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNpdGUgPSAkKGRhdGEpXG4gICAgICAgICAgICAgICAgdmFyIHJldmVyc2VkVGVtcERhdGEgPSBbXVxuICAgICAgICAgICAgICAgIHNpdGUuZmluZCgnI29mZmVyc190YWJsZScpLmZpbmQoJ3RyIHRkLm9mZmVyJykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCgkKGVsZW1lbnQpLmZpbmQoJy5vYnNlcnZlbGlua2luZm8gYScpLmF0dHIoJ2NsYXNzJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpZCA9ICQoZWxlbWVudCkuZmluZCgnLm9ic2VydmVsaW5raW5mbyBhJykuYXR0cignY2xhc3MnKS5zcGxpdCgnICcpWzBdLnJlcGxhY2UoL2lkfDp8fXx7L2dtLCAnJylcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoXy5maW5kKGxpc3QsIGZ1bmN0aW9uIChlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsLmhhc2hJZCA9PT0gcGFyc2VJbnQoaWQpXG4gICAgICAgICAgICAgICAgICAgICAgfSkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV2ZXJzZWRUZW1wRGF0YS51bnNoaWZ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hJZDogcGFyc2VJbnQoaWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaWNlOiBfLnRyaW0oJChlbGVtZW50KS5maW5kKCdwLnByaWNlIHN0cm9uZycpLmh0bWwoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAkKGVsZW1lbnQpLmZpbmQoJy5saW5rV2l0aEhhc2ggc3Ryb25nJykuaHRtbCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluazogJChlbGVtZW50KS5maW5kKCcubGlua1dpdGhIYXNoJykuYXR0cignaHJlZicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiAkKGVsZW1lbnQpLmZpbmQoJy5saW5rV2l0aEhhc2ggaW1nJykuYXR0cignc3JjJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdvbHgnXG4gICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgXy5mb3JFYWNoKHJldmVyc2VkVGVtcERhdGEsIGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICBsaXN0LnVuc2hpZnQoZWxlbWVudClcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgICAgIHNldExpc3QobGlzdClcbiAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciA6KCcpXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBnZXREYXRhRnJvbUd1bXRyZWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgdmFyIGd1bXRyZWVMaW5rID0gc2V0dGluZ3MuZ3VtdHJlZUxpbmtcblxuICAgICAgICAgIGlmICghc2V0dGluZ3MuYWR2YW5jZWQpIHtcbiAgICAgICAgICAgIGd1bXRyZWVMaW5rID0gTGlua1NlcnZpY2UuZ2V0R3VtdHJlZUxpbmtCeVNldHRpbmdzKHNldHRpbmdzKVxuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBjYW5ub3QgdXNlICRodHRwLmpzb25wKCkgYmVjYXVzZSBvZiBDb250ZW50IFNlY3VyaXR5IFBvbGljeVxuICAgICAgICAgIGlmICghZ3VtdHJlZUxpbmspIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGd1bXRyZWVMaW5rLmZvckVhY2goZnVuY3Rpb24gKGxpbmspIHtcbiAgICAgICAgICAgIGlmICghbGluaykge1xuICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgNjsgaSsrKSB7XG4gICAgICAgICAgICAgIHZhciBwYWdlTGluayA9IGxpbmtcbiAgICAgICAgICAgICAgaWYgKGkgPiAxKSB7XG4gICAgICAgICAgICAgICAgcGFnZUxpbmsgPSBsaW5rLnNwbGl0KCdwMT8nKVsxXSA/IChsaW5rLnNwbGl0KCdwMT8nKVswXSArICdwJyArIGkgKyAnPydcbiAgICAgICAgICAgICAgICArIGxpbmsuc3BsaXQoJ3AxPycpWzFdKSA6IGxpbmtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoaSA+IDIgJiYgbGluay5pbmRleE9mKCdwMT8nKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAkaHR0cC5nZXQocGFnZUxpbmspXG4gICAgICAgICAgICAgICAgLnN1Y2Nlc3MoZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgIHZhciBmZWVkID0gJChkYXRhKVxuICAgICAgICAgICAgICAgICAgdmFyIHJldmVyc2VkVGVtcERhdGEgPSBbXVxuXG4gICAgICAgICAgICAgICAgICBmZWVkLmZpbmQoJy52aWV3Om5vdCgudG9wLWxpc3RpbmdzKScpLmZpbmQoJ3VsIGxpLnJlc3VsdCcpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpZCA9ICQoZWxlbWVudCkuZmluZCgnLmFkZEFkVG9mYXYnKS5hdHRyKCdkYXRhLWFkaWQnKVxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChfLmZpbmQobGlzdCwgZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuaGFzaElkID09PSBwYXJzZUludChpZClcbiAgICAgICAgICAgICAgICAgICAgICB9KSkgJiYgIV8uaXNVbmRlZmluZWQoaWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV2ZXJzZWRUZW1wRGF0YS51bnNoaWZ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hJZDogcGFyc2VJbnQoaWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpY2U6IF8udHJpbSgkKGVsZW1lbnQpLmZpbmQoJy5wcmljZSAuYW1vdW50JykuaHRtbCgpLnJlcGxhY2UoJyZuYnNwOycsICcgJykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogXy50cmltKCQoZWxlbWVudCkuZmluZCgnLmhyZWYtbGluaycpLnRleHQoKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiAnaHR0cDovL3d3dy5ndW10cmVlLnBsJyArICQoZWxlbWVudCkuZmluZCgnLmhyZWYtbGluaycpLmF0dHIoJ2hyZWYnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZzogJChlbGVtZW50KS5maW5kKCcjaW1nLWNudCBpbWcnKS5hdHRyKCdzcmMnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGU6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdndW10cmVlJ1xuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaChyZXZlcnNlZFRlbXBEYXRhLCBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBsaXN0LnVuc2hpZnQoZWxlbWVudClcbiAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgIGNocm9tZS5icm93c2VyQWN0aW9uLnNldEJhZGdlVGV4dCh7dGV4dDogJycgKyBnZXRVbnNlZW4oKSArICcnfSlcbiAgICAgICAgICAgICAgICAgIHNldExpc3QobGlzdClcbiAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbiAoZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgOignKVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBzZXRTZXR0aW5ncyA9IGZ1bmN0aW9uIChzZXR0aW5ncykge1xuICAgICAgICAgIGNocm9tZS5zdG9yYWdlLnN5bmMuc2V0KHtzZXR0aW5nczogc2V0dGluZ3N9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBObyBuZWVkIHRvIG5vdGlmeSB0aGF0IHNldHRpbmdzIGhhcyBiZWVuIHNhdmVkLlxuICAgICAgICAgICAgY2hyb21lLnN0b3JhZ2UubG9jYWwuY2xlYXIoKVxuICAgICAgICAgICAgbGlzdCA9IFtdXG4gICAgICAgICAgICBnZXRTZXR0aW5ncygpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGdldFNldHRpbmdzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNocm9tZS5zdG9yYWdlLnN5bmMuZ2V0KCdzZXR0aW5ncycsIGZ1bmN0aW9uIChzdG9yZWRTZXR0aW5ncykge1xuICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHN0b3JlZFNldHRpbmdzLnNldHRpbmdzKSAmJiAhXy5pc1VuZGVmaW5lZChzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5vbHhMaW5rKSkge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLm9seExpbmsgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3Mub2x4TGluayA9IFtcbiAgICAgICAgICAgICAgICAgIHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLm9seExpbmtcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5ndW10cmVlTGluayA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBzdG9yZWRTZXR0aW5ncy5zZXR0aW5ncy5ndW10cmVlTGluayA9IFtcbiAgICAgICAgICAgICAgICAgIHN0b3JlZFNldHRpbmdzLnNldHRpbmdzLmd1bXRyZWVMaW5rXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHNldHRpbmdzID0gc3RvcmVkU2V0dGluZ3Muc2V0dGluZ3NcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldE9sZExpc3QoKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBpZiAobGlzdC5sZW5ndGggPiA1MDApIHtcbiAgICAgICAgICAgIHZhciB0ZW1wTGlzdCA9IFtdXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDUwMDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRlbXBMaXN0LnB1c2gobGlzdFtpXSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxpc3QgPSB0ZW1wTGlzdFxuICAgICAgICAgICAgY2hyb21lLmJyb3dzZXJBY3Rpb24uc2V0QmFkZ2VUZXh0KHt0ZXh0OiAnJyArIGdldFVuc2VlbigpICsgJyd9KVxuICAgICAgICAgICAgc2V0TGlzdChsaXN0KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGdldFNldHRpbmdzKClcbiAgICAgICAgJGludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBnZXREYXRhRnJvbU9seCgpXG4gICAgICAgICAgZ2V0RGF0YUZyb21HdW10cmVlKClcbiAgICAgICAgICBjaGVja0lmTm90VG9NdWNoRGF0YSgpXG4gICAgICAgIH0sIHNldHRpbmdzLmludGVydmFsICogNjAgKiAxMDAwKVxuICAgICAgfV0pXG59KSgpIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9